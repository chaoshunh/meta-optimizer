import math
import torch

def preprocess_gradients(x):
    p, eps = 10, 1e-6
    indicator = (x.abs() > math.exp(-p)).float()
    x1 = (x.abs()+eps).log() / p*indicator-(1-indicator)
    x2 = x.sign()*indicator + math.exp(p)*x*(1-indicator)

    return torch.cat((x1,x2),1)
